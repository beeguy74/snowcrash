name: AI docs update PR (Gemini)

on:
  push:
    branches: [main]
    # Avoid infinite loops / noise: don't re-run just because docs or workflows changed
    paths-ignore:
      - "docs/**"
      - ".github/workflows/**"
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: ai-docs-pr
  cancel-in-progress: true

jobs:
  docs:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Write change diff to file
      # Uses the push event range when possible; falls back to HEAD if needed.
        shell: bash
        run: |
          set -euo pipefail
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"

          if [[ -n "${BEFORE}" && "${BEFORE}" != "0000000000000000000000000000000000000000" ]]; then
            git diff --no-color --unified=0 "${BEFORE}" "${AFTER}" > changes.diff || true
          else
            git show --no-color --unified=0 > changes.diff || true
          fi

      - name: Run Gemini to update docs
        uses: google-github-actions/run-gemini-cli@v0.1.14
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          prompt: |
            Update documentation under ./docs to reflect the changes described in changes.diff.

            Rules:
            - Only modify files under ./docs
            - Do not modify code
            - If no documentation updates are needed, make no changes

            Please read changes.diff from the repository workspace and apply necessary edits.

      # Keep the working tree clean so we don't accidentally commit runner outputs.
      - name: Cleanup non-doc outputs
        if: always()
        shell: bash
        run: |
          rm -f changes.diff || true
          rm -rf gemini-artifacts .gemini || true

      - name: Guardrail - fail if non-doc files changed
        shell: bash
        run: |
          set -euo pipefail
          NON_DOC="$(git status --porcelain | grep -vE '^(.. )?docs/' || true)"
          if [[ -n "${NON_DOC}" ]]; then
            echo "::error title=Guardrail tripped::Non-doc files were changed. Only docs/** is allowed."
            echo "${NON_DOC}"
            exit 1
          fi

      - name: Guardrail - fail if docs unchanged
        shell: bash
        run: |
          set -euo pipefail
          DOCS="$(git status --porcelain docs/ || true)"
          if [[ -z "${DOCS}" ]]; then
            echo "::error title=No docs changes::No files were created/modified under docs/. Nothing to open a PR for."
            exit 1
          fi
          echo "Docs changes detected:"
          echo "${DOCS}"

      - name: Create PR with doc changes only
        uses: peter-evans/create-pull-request@v7
        with:
          branch: ai/docs-sync
          title: "docs: sync with latest code changes (Gemini)"
          commit-message: "docs: sync with latest code changes (Gemini)"
          body: "Automated documentation update."
          labels: automated,documentation
          add-paths: |
            docs/**
